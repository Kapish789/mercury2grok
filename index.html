<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Liquid Metal Effect</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Open Sans', 'Helvetica Neue', sans-serif;
        }

        body {
            background-color: #0a0a0a;
            color: #fff;
            display: flex;
            min-height: 100vh;
            overflow: hidden;
        }

        .container {
            display: flex;
            width: 100%;
            height: 100vh;
        }

        .preview-panel {
            flex: 1;
            position: relative;
        }

        .canvas-container {
            width: 100%;
            height: 100%;
            background-color: #1a1a1a;
            overflow: hidden;
            position: relative;
        }

        #metalCanvas {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
        }

        .controls-panel {
            width: 340px;
            background-color: #111;
            padding: 20px;
            overflow-y: auto;
            display: flex;
            flex-direction: column;
            gap: 20px;
        }

        .control-group {
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .control-label {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .control-value {
            color: #fff;
            background-color: #333;
            padding: 4px 8px;
            border-radius: 4px;
            font-size: 14px;
            min-width: 60px;
            text-align: center;
        }

        .slider-container {
            position: relative;
            height: 4px;
            background-color: rgba(255, 255, 255, 0.2);
            border-radius: 2px;
        }

        .slider-fill {
            position: absolute;
            height: 100%;
            background-color: #3b82f6;
            border-radius: 2px;
        }

        input[type="range"] {
            -webkit-appearance: none;
            width: 100%;
            height: 4px;
            background: transparent;
            position: absolute;
            top: 0;
            left: 0;
            margin: 0;
        }

        input[type="range"]::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        input[type="range"]::-moz-range-thumb {
            width: 16px;
            height: 16px;
            border-radius: 50%;
            background: white;
            cursor: pointer;
            border: none;
            box-shadow: 0 0 5px rgba(0, 0, 0, 0.3);
        }

        .background-options {
            display: flex;
            gap: 10px;
        }

        .bg-option {
            width: 24px;
            height: 24px;
            border-radius: 50%;
            cursor: pointer;
            border: 2px solid transparent;
            transition: transform 0.2s ease;
        }

        .bg-option:hover {
            transform: scale(1.1);
        }

        .bg-option.active {
            border-color: white;
        }

        .bg-metal {
            background: linear-gradient(135deg, #888, #ddd, #888);
        }

        .bg-white {
            background-color: #fff;
        }

        .bg-black {
            background-color: #000;
            border: 2px solid #333;
        }

        .bg-custom {
            background: conic-gradient(red, yellow, lime, aqua, blue, magenta, red);
        }

        .upload-btn {
            display: block;
            width: 100%;
            padding: 12px;
            background-color: #3b82f6;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
            text-align: center;
            margin-top: auto;
            transition: background-color 0.2s;
        }

        .upload-btn:hover {
            background-color: #2563eb;
        }

        .tips {
            margin-top: 16px;
            font-size: 12px;
            color: #888;
            line-height: 1.5;
        }

        #fileInput {
            display: none;
        }

        @media (max-width: 768px) {
            .container {
                flex-direction: column;
            }
            
            .preview-panel {
                height: 60vh;
            }
            
            .controls-panel {
                width: 100%;
                height: 40vh;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="preview-panel">
            <div class="canvas-container">
                <canvas id="metalCanvas"></canvas>
            </div>
        </div>
        
        <div class="controls-panel">
            <div class="control-group">
                <div class="control-label">
                    <span>Background</span>
                </div>
                <div class="background-options">
                    <div class="bg-option bg-metal active" data-bg="metal"></div>
                    <div class="bg-option bg-white" data-bg="white"></div>
                    <div class="bg-option bg-black" data-bg="black"></div>
                    <div class="bg-option bg-custom" data-bg="custom"></div>
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Refraction</span>
                    <span class="control-value" id="refractionValue">0.040</span>
                </div>
                <div class="slider-container">
                    <div class="slider-fill" id="refractionFill" style="width: 20%;"></div>
                    <input type="range" id="refraction" min="0" max="0.2" step="0.001" value="0.04">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Edge</span>
                    <span class="control-value" id="edgeValue">1.000</span>
                </div>
                <div class="slider-container">
                    <div class="slider-fill" id="edgeFill" style="width: 100%;"></div>
                    <input type="range" id="edge" min="0" max="1" step="0.001" value="1">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Pattern Blur</span>
                    <span class="control-value" id="patternBlurValue">0.000</span>
                </div>
                <div class="slider-container">
                    <div class="slider-fill" id="patternBlurFill" style="width: 0%;"></div>
                    <input type="range" id="patternBlur" min="0" max="1" step="0.001" value="0">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Liquid</span>
                    <span class="control-value" id="liquidValue">0.610</span>
                </div>
                <div class="slider-container">
                    <div class="slider-fill" id="liquidFill" style="width: 61%;"></div>
                    <input type="range" id="liquid" min="0" max="1" step="0.001" value="0.61">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Speed</span>
                    <span class="control-value" id="speedValue">1.000</span>
                </div>
                <div class="slider-container">
                    <div class="slider-fill" id="speedFill" style="width: 50%;"></div>
                    <input type="range" id="speed" min="0" max="2" step="0.001" value="1">
                </div>
            </div>
            
            <div class="control-group">
                <div class="control-label">
                    <span>Pattern Scale</span>
                    <span class="control-value" id="patternScaleValue">10</span>
                </div>
                <div class="slider-container">
                    <div class="slider-fill" id="patternScaleFill" style="width: 50%;"></div>
                    <input type="range" id="patternScale" min="1" max="20" step="0.1" value="10">
                </div>
            </div>
            
            <label for="fileInput" class="upload-btn">Upload Image</label>
            <input type="file" id="fileInput" accept="image/*">
            
            <div class="tips">
                Tips: Transparent or white background works best. Shapes are better than text. Use SVG or high-res images (500px-1000px recommended). Max 4.5MB.
            </div>
        </div>
    </div>

    <script type="module">
        import * as THREE from 'https://cdn.jsdelivr.net/npm/three@0.150.1/build/three.module.js';

        // Configuration and state
        const config = {
            refraction: 0.04,
            edge: 1.0,
            patternBlur: 0.0,
            liquid: 0.61,
            speed: 1.0,
            patternScale: 10.0,
            background: 'metal'
        };

        // Parse URL parameters
        function parseUrlParams() {
            const params = new URLSearchParams(window.location.search);
            
            if (params.has('refraction')) config.refraction = parseFloat(params.get('refraction'));
            if (params.has('edge')) config.edge = parseFloat(params.get('edge'));
            if (params.has('patternBlur')) config.patternBlur = parseFloat(params.get('patternBlur'));
            if (params.has('liquid')) config.liquid = parseFloat(params.get('liquid'));
            if (params.has('speed')) config.speed = parseFloat(params.get('speed'));
            if (params.has('patternScale')) config.patternScale = parseFloat(params.get('patternScale'));
            if (params.has('background')) config.background = params.get('background');
            
            // Update UI to match URL parameters
            updateUIFromConfig();
        }

        // Update URL parameters
        function updateUrlParams() {
            const url = new URL(window.location);
            url.searchParams.set('refraction', config.refraction);
            url.searchParams.set('edge', config.edge);
            url.searchParams.set('patternBlur', config.patternBlur);
            url.searchParams.set('liquid', config.liquid);
            url.searchParams.set('speed', config.speed);
            url.searchParams.set('patternScale', config.patternScale);
            url.searchParams.set('background', config.background);
            
            window.history.replaceState({}, '', url);
        }

        // Three.js setup
        let scene, camera, renderer, clock, material, uniforms;
        let logoTexture;
        
        // Initialize the scene
        function init() {
            // Create scene
            scene = new THREE.Scene();
            
            // Create camera (orthographic for 2D effect)
            camera = new THREE.OrthographicCamera(-1, 1, 1, -1, 0.1, 10);
            camera.position.z = 1;
            
            // Create renderer
            const canvas = document.getElementById('metalCanvas');
            renderer = new THREE.WebGLRenderer({ 
                canvas: canvas,
                antialias: true,
                alpha: true
            });
            
            // Set renderer size to match canvas container
            updateRendererSize();
            
            // Create clock for animation
            clock = new THREE.Clock();
            
            // Create a full-screen quad
            const geometry = new THREE.PlaneGeometry(2, 2);
            
            // Load default logo (Apple logo)
            loadDefaultLogo();
            
            // Create uniforms for the shader
            uniforms = {
                u_time: { value: 0 },
                u_resolution: { value: new THREE.Vector2() },
                u_refraction: { value: config.refraction },
                u_edge: { value: config.edge },
                u_patternBlur: { value: config.patternBlur },
                u_liquid: { value: config.liquid },
                u_speed: { value: config.speed },
                u_patternScale: { value: config.patternScale },
                u_background: { value: getBackgroundValue(config.background) },
                u_logoTexture: { value: null }
            };
            
            // Create material with shaders
            material = new THREE.ShaderMaterial({
                uniforms: uniforms,
                vertexShader: vertexShader(),
                fragmentShader: fragmentShader()
            });
            
            // Create mesh and add to scene
            const mesh = new THREE.Mesh(geometry, material);
            scene.add(mesh);
            
            // Handle window resize
            window.addEventListener('resize', onWindowResize);
            
            // Start animation loop
            animate();
        }
        
        // Load the default Apple logo
        function loadDefaultLogo() {
            // Create a canvas to draw the Apple logo
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            canvas.width = 512;
            canvas.height = 512;
            
            // Clear canvas
            ctx.clearRect(0, 0, canvas.width, canvas.height);
            
            // Draw Apple logo (simplified path)
            ctx.fillStyle = 'white';
            const appleLogoPath = new Path2D('M213.5,127.5c0,0-11.3-23.3-36.5-23.3s-43.8,21.8-43.8,21.8s-22.8-9.8-38.3,6.8s-15.5,41.3-15.5,41.3 s-38.3,67.8-38.3,147.8s55.3,66.8,55.3,66.8s27.8,1.5,48.8-25.5c21-27,20.3-27,20.3-27s9,0,20.3,0s9,0,20.3,0s-0.8,0,20.3,27 c21,27,48.8,25.5,48.8,25.5s55.3,13.3,55.3-66.8s-38.3-147.8-38.3-147.8s0-24.8-15.5-41.3s-38.3-6.8-38.3-6.8s-18.5-21.8-43.8-21.8 S213.5,127.5,213.5,127.5z M213.5,127.5c0,0,5.3-15.8,15-15.8s15,15.8,15,15.8');
            ctx.fill(appleLogoPath);
            
            // Create texture from canvas
            logoTexture = new THREE.CanvasTexture(canvas);
            logoTexture.needsUpdate = true;
            
            // Update uniform
            if (uniforms) {
                uniforms.u_logoTexture.value = logoTexture;
            }
        }
        
        // Update renderer size to match container
        function updateRendererSize() {
            const container = document.querySelector('.canvas-container');
            const width = container.clientWidth;
            const height = container.clientHeight;
            
            renderer.setSize(width, height);
            
            if (uniforms) {
                uniforms.u_resolution.value.set(width, height);
            }
        }
        
        // Handle window resize
        function onWindowResize() {
            updateRendererSize();
        }
        
        // Animation loop
        function animate() {
            requestAnimationFrame(animate);
            
            // Update time uniform
            if (uniforms) {
                uniforms.u_time.value = clock.getElapsedTime() * config.speed;
            }
            
            // Render scene
            renderer.render(scene, camera);
        }
        
        // Convert background string to numeric value for shader
        function getBackgroundValue(bg) {
            switch(bg) {
                case 'metal': return 0;
                case 'white': return 1;
                case 'black': return 2;
                case 'custom': return 3;
                default: return 0;
            }
        }
        
        // Vertex shader
        function vertexShader() {
            return `
                varying vec2 vUv;
                
                void main() {
                    vUv = uv;
                    gl_Position = projectionMatrix * modelViewMatrix * vec4(position, 1.0);
                }
            `;
        }
        
        // Fragment shader
        function fragmentShader() {
            return `
                uniform float u_time;
                uniform vec2 u_resolution;
                uniform float u_refraction;
                uniform float u_edge;
                uniform float u_patternBlur;
                uniform float u_liquid;
                uniform float u_speed;
                uniform float u_patternScale;
                uniform int u_background;
                uniform sampler2D u_logoTexture;
                
                varying vec2 vUv;
                
                // Noise functions
                vec3 mod289(vec3 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                vec2 mod289(vec2 x) { return x - floor(x * (1.0 / 289.0)) * 289.0; }
                vec3 permute(vec3 x) { return mod289(((x*34.0)+1.0)*x); }
                
                // Simplex noise
                float snoise(vec2 v) {
                    const vec4 C = vec4(0.211324865405187, 0.366025403784439,
                        -0.577350269189626, 0.024390243902439);
                    
                    vec2 i  = floor(v + dot(v, C.yy));
                    vec2 x0 = v - i + dot(i, C.xx);
                    
                    vec2 i1;
                    i1 = (x0.x > x0.y) ? vec2(1.0, 0.0) : vec2(0.0, 1.0);
                    vec4 x12 = x0.xyxy + C.xxzz;
                    x12.xy -= i1;
                    
                    i = mod289(i);
                    vec3 p = permute(permute(i.y + vec3(0.0, i1.y, 1.0))
                        + i.x + vec3(0.0, i1.x, 1.0));
                        
                    vec3 m = max(0.5 - vec3(dot(x0, x0), dot(x12.xy, x12.xy), dot(x12.zw, x12.zw)), 0.0);
                    m = m*m;
                    m = m*m;
                    
                    vec3 x = 2.0 * fract(p * C.www) - 1.0;
                    vec3 h = abs(x) - 0.5;
                    vec3 ox = floor(x + 0.5);
                    vec3 a0 = x - ox;
                    
                    m *= 1.79284291400159 - 0.85373472095314 * (a0*a0 + h*h);
                    
                    vec3 g;
                    g.x = a0.x * x0.x + h.x * x0.y;
                    g.yz = a0.yz * x12.xz + h.yz * x12.yw;
                    return 130.0 * dot(m, g);
                }
                
                // FBM (Fractal Brownian Motion)
                float fbm(vec2 p) {
                    float sum = 0.0;
                    float amp = 1.0;
                    float freq = 1.0;
                    
                    // Loop for octaves
                    for(int i = 0; i < 6; i++) {
                        sum += amp * snoise(p * freq);
                        amp *= 0.5;
                        freq *= 2.0;
                    }
                    
                    return sum;
                }
                
                // Edge detection for logo
                float getLogoEdge(sampler2D tex, vec2 uv, float edge) {
                    // Sample logo texture
                    float logo = texture2D(tex, uv).r;
                    
                    // Sample neighboring pixels for edge detection
                    float dx = 1.0 / u_resolution.x;
                    float dy = 1.0 / u_resolution.y;
                    
                    float n = texture2D(tex, uv + vec2(0.0, dy)).r;
                    float e = texture2D(tex, uv + vec2(dx, 0.0)).r;
                    float s = texture2D(tex, uv + vec2(0.0, -dy)).r;
                    float w = texture2D(tex, uv + vec2(-dx, 0.0)).r
